{% extends 'myadmin/base.html' %}
{% block main_body %}

<h2 class="text-xl font-bold mb-4">数据分析报表</h2>

<!-- 图表选择器 -->
<form method="get" class="mb-4">
  <label class="block mb-1 font-medium">选择要显示的图表：</label>
  <select name="charts" multiple class="w-full md:w-1/3 border border-gray-300 rounded px-3 py-2" size="4">
    <option value="daily_orders" {% if show_all or 'daily_orders' in selected_charts %}selected{% endif %}>每日订单趋势</option>
    <option value="top_products" {% if show_all or 'top_products' in selected_charts %}selected{% endif %}>出货型号前十</option>
    <option value="customer_levels" {% if show_all or 'customer_levels' in selected_charts %}selected{% endif %}>客户等级分布</option>
    <option value="monthly_top_products1" {% if show_all or 'monthly_top_products1' in selected_charts %}selected{% endif %}>按月的出货前十产品（动态）</option>

  </select>
  <button type="submit" class="ml-2 bg-primary text-white px-4 py-2 rounded">应用</button>
</form>

<!-- 图表容器 -->
<div class="grid grid-cols-1 gap-6">

  {% if show_all or 'daily_orders' in selected_charts %}
  <div class="bg-white p-4 shadow rounded">
    <h3 class="text-lg font-semibold mb-2">每日订单数量</h3>
    <div id="daily_chart" style="height: 400px;"></div>
  </div>
  {% endif %}

  {% if show_all or 'top_products' in selected_charts %}
  <div class="bg-white p-4 shadow rounded">
    <h3 class="text-lg font-semibold mb-2">历史以来出货型号前十</h3>
    <div id="top_chart" style="height: 400px;"></div>
  </div>
  {% endif %}


  {% if show_all or 'customer_levels' in selected_charts %}
  <div class="bg-white p-4 shadow rounded">
    <h3 class="text-lg font-semibold mb-2">客户等级分布</h3>
    <div id="level_chart" style="height: 400px;"></div>
  </div>
  {% endif %}

  {% if show_all or 'monthly_top_products1' in selected_charts %}
  <div class="bg-white p-4 shadow rounded">
    <div class="flex items-center justify-between mb-2">
      <h3 class="text-lg font-semibold">按月份出货前十产品</h3>
      <select id="monthlyChartSelect" class="border border-gray-300 rounded px-3 py-1">
        {% for month in all_months %}
        <option value="{{ month }}">{{ month }}</option>
        {% endfor %}
      </select>
    </div>
    <div id="monthly_chart_v2" style="height: 400px;"></div>
  </div>
  {% endif %}


</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
<script>
  {% if show_all or 'daily_orders' in selected_charts %}
  const dailyChart = echarts.init(document.getElementById('daily_chart'));
  dailyChart.setOption({
    xAxis: { type: 'category', data: {{ daily_chart.dates|safe }} },
    yAxis: { type: 'value' },
    tooltip: { trigger: 'axis' },
    series: [{
      name: '订单数',
      type: 'line',
      data: {{ daily_chart.counts|safe }},
      smooth: true
    }]
  });
  {% endif %}

  {% if show_all or 'top_products' in selected_charts %}
  const topChart = echarts.init(document.getElementById('top_chart'));
  topChart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: function (params) {
        return `<strong>${params.name}</strong><br/>累计销售量: ${params.value}`;
      }
    },
    xAxis: {
      type: 'value',
      name: '数量'
    },
    yAxis: {
      type: 'category',
      data: {{ top_chart_labels|safe }},
      axisLabel: {
        interval: 0,
        formatter: function (value) {
          return value.length > 20 ? value.slice(0, 20) + '…' : value;
        }
      }
    },
    series: [{
      name: '销售量',
      type: 'bar',
      data: {{ top_chart_values|safe }},
      itemStyle: {
        color: '#60a5fa'
      },
      label: {
        show: true,
        position: 'right'
      }
    }],
    grid: {
      left: '120px',
      containLabel: true
    }
  });
  {% endif %}

  {% if show_all or 'customer_levels' in selected_charts %}
  const levelChart = echarts.init(document.getElementById('level_chart'));
  levelChart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}<br/>数量: {c} ({d}%)'
    },
    legend: {
      orient: 'vertical',
      left: 'left'
    },
    series: [{
      name: '客户等级',
      type: 'pie',
      radius: '60%',
      data: {{ level_chart_data|safe }},
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      }
    }]
  });
  {% endif %}

  {% if show_all or 'monthly_top_products1' in selected_charts %}
  const monthlyChartMap = {{ monthly_chart_map|safe }};
  const monthlyChartV2 = echarts.init(document.getElementById('monthly_chart_v2'));
  
  function renderMonthlyV2Chart(month) {
    const data = monthlyChartMap[month] || [];
    monthlyChartV2.setOption({
      tooltip: {
        trigger: 'item',
        formatter: p => `<strong>${p.name}</strong><br>累计出货量：${p.value}`
      },
      xAxis: { type: 'value', name: '数量' },
      yAxis: {
        type: 'category',
        data: data.map(item => item.name),
        axisLabel: { interval: 0 }
      },
      series: [{
        type: 'bar',
        data: data.map(item => item.value),
        label: { show: true, position: 'right' },
        itemStyle: { color: '#60a5fa' }
      }],
      grid: { left: '120px', containLabel: true }
    });
  }
  
  const monthSelect = document.getElementById("monthlyChartSelect");
  if (monthSelect) {
    renderMonthlyV2Chart(monthSelect.value);
    monthSelect.addEventListener("change", () => {
      renderMonthlyV2Chart(monthSelect.value);
    });
  }
  {% endif %}

</script>

{% endblock %}
